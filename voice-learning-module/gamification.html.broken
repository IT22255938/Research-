<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gamification Dashboard - Track progress, earn badges, and compete on leaderboards">
    <meta name="theme-color" content="#667eea">
    <title>Gamification Dashboard - VoiceLearn Pro</title>
    
    <!-- Design System & Components CSS -->
    <link rel="stylesheet" href="src/styles/design-system.css">
    <link rel="stylesheet" href="src/styles/components.css">
    
    <style>
        /* Page-specific dashboard styles */
        .app-header {
            background: var(--gradient-primary);
            color: white;
            padding: var(--spacing-lg) 0;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: var(--z-fixed);
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 var(--spacing-lg);
            gap: var(--spacing-lg);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .brand-icon {
            font-size: var(--font-size-3xl);
            line-height: 1;
        }

        .main-nav {
            display: flex;
            gap: var(--spacing-lg);
            flex: 1;
            justify-content: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            transition: var(--transition-colors);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: var(--font-weight-semibold);
            transition: var(--transition-colors);
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            max-width: 1200px;
            margin: var(--spacing-2xl) auto;
            padding: 0 var(--spacing-lg);
        }


        .main-content {
            max-width: 1200px;
            margin: var(--spacing-2xl) auto;
            padding: 0 var(--spacing-lg);
        }

        /* Profile Card */
        .profile-card {
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: var(--spacing-xl);
            align-items: center;
        }

        .profile-info {
            text-align: center;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: var(--radius-full);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-5xl);
            margin: 0 auto var(--spacing-md);
            color: white;
        }

        .profile-name {
            font-size: var(--font-size-xl);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-sm);
            font-weight: var(--font-weight-bold);
        }

        .profile-level {
            color: var(--color-primary);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
        }

        .xp-bar-container {
            flex: 1;
        }

        .xp-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .xp-bar {
            width: 100%;
            height: 30px;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--color-border);
        }

        .xp-fill {
            height: 100%;
            background: var(--gradient-success);
            border-radius: var(--radius-full);
            transition: width var(--transition-slow) var(--transition-timing);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
        }

        .stat-box {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--color-primary);
        }

        .stat-number {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-sm);
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
        }

        /* Card Styles */
        .card {
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            transition: var(--transition-all);
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-4px);
        }

        .card h2 {
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        /* Badges Section */
        .badges-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .badge-stats {
            display: flex;
            gap: var(--spacing-xl);
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
        }

        .badge-stat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .badge-stat-number {
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            font-size: var(--font-size-lg);
        }

        .badge-completion-bar {
            width: 200px;
            height: 8px;
            background: var(--color-border);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .badge-completion-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width var(--transition-slow) var(--transition-timing);
        }

        .badges-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--spacing-md);
        }

        .badge {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-xl);
            border: 2px solid var(--color-border);
            transition: var(--transition-all);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform var(--transition-base) var(--transition-timing);
        }

        .badge:hover::before {
            transform: scaleX(1);
        }

        .badge:hover {
            transform: translateY(-6px);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-primary);
        }

        .badge-icon {
            font-size: var(--font-size-5xl);
            margin-bottom: var(--spacing-sm);
            display: block;
            transition: transform var(--transition-base) var(--transition-timing);
        }

        .badge:hover .badge-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .badge-name {
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
            word-break: break-word;
            line-height: var(--line-height-tight);
        }

        .badge-rarity {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }

        .badge-date {
            color: var(--color-text-tertiary);
            font-size: var(--font-size-xs);
            margin-top: var(--spacing-xs);
        }

        /* Rarity Colors */
        .badge.rarity-common .badge-rarity {
            background: #d4edda;
            color: #155724;
        }

        .badge.rarity-uncommon .badge-rarity {
            background: #cfe2ff;
            color: #084298;
        }

        .badge.rarity-rare .badge-rarity {
            background: #e2e3ff;
            color: #3a3aff;
        }

        .badge.rarity-epic .badge-rarity {
            background: #f8d7ff;
            color: #702963;
        }

        .badge.rarity-legendary .badge-rarity {
            background: #fff3cd;
            color: #856404;
        }

        /* Badge Tooltip */
        .badge-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .badge-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
        }

        .badge:hover .badge-tooltip {
            display: block;
            animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .badge.locked {
            opacity: 0.6;
            background: linear-gradient(135deg, #f0f0f0 0%, #f9f9f9 100%);
            border-color: #ddd;
        }

        .badge.locked::after {
            content: 'üîí';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.2em;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .badge.locked .badge-icon {
            opacity: 0.4;
        }

        .badge.locked .badge-rarity {
            opacity: 0.6;
        }

        .badge.locked:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #ccc;
        }

        .badge-unlock-progress {
            font-size: 0.7em;
            color: #999;
            margin-top: 3px;
        }

        /* Achievements */
        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            transition: all 0.3s ease;
        }

        .achievement-item:hover {
            background: #fff8e1;
            transform: translateX(5px);
        }

        .achievement-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .achievement-details {
            flex: 1;
        }

        .achievement-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .achievement-desc {
            color: #666;
            font-size: 0.9em;
        }

        .achievement-progress {
            margin-left: auto;
            text-align: right;
            color: #667eea;
            font-weight: bold;
        }

        /* Leaderboard */
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }

        .rank.gold {
            color: #ffc107;
        }

        .rank.silver {
            color: #c0c0c0;
        }

        .rank.bronze {
            color: #cd7f32;
        }

        .leaderboard-info {
            flex: 1;
            margin: 0 15px;
        }

        .leaderboard-name {
            font-weight: bold;
            color: #333;
        }

        .leaderboard-xp {
            color: #667eea;
            font-weight: bold;
            text-align: right;
        }

        /* Activity Section */
        .activity-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            grid-column: 1 / -1;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .activity-card {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .activity-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .activity-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .activity-stats {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f4ff;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-card {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .quick-stats {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #000;
        }
</head>
<body>
    <!-- Professional Header -->
    <header class="app-header">
        <div class="header-container">
            <div class="brand">
                <div class="brand-icon">üéÆ</div>
                <div class="brand-name">
                    <div class="brand-name-main">Gamification Dashboard</div>
                </div>
            </div>
            
            <nav class="main-nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="gamification.html" class="nav-link active">Dashboard</a>
                <a href="simple-activities.html" class="nav-link">Activities</a>
            </nav>
            
            <button class="btn-back" onclick="window.history.back()">‚Üê Back</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Student Profile Card -->
        <div class="profile-card">
            <div class="profile-info">
                <div class="profile-avatar" id="avatar">üéì</div>
                <div class="profile-name" id="studentName">Loading...</div>
                <div class="profile-level" id="levelDisplay">Level 1</div>
            </div>

            <div class="xp-bar-container">
                <div class="xp-label">
                    <span>Experience Progress</span>
                    <span id="xpText">0 / 100 XP</span>
                </div>
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%">
                        <span id="xpPercent">0%</span>
                    </div>
                </div>
            </div>

            <div class="quick-stats">
                <div class="stat-box">
                    <div class="stat-number" id="sessionsCount">0</div>
                    <div class="stat-label">Sessions</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="accuracyCount">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="xpCount">0</div>
                    <div class="stat-label">Total XP</div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Badges Section -->
            <div class="card">
                <div class="badges-section-header">
                    <h2 style="margin: 0;">‚≠ê Badges Earned</h2>
                    <div class="badge-stats">
                        <div class="badge-stat-item">
                            <span>Earned:</span>
                            <span class="badge-stat-number" id="badgesEarned">0</span>
                            <span>/ <span id="badgesTotal">6</span></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="badge-completion-bar">
                                <div class="badge-completion-fill" id="badgeCompletionFill" style="width: 0%"></div>
                            </div>
                            <span style="font-size: 0.9em; color: var(--color-primary); font-weight: bold;" id="badgeCompletionPercent">0%</span>
                        </div>
                    </div>
                </div>
                <div class="badges-container" id="badgesContainer">
                    <div class="badge locked">
                        <div class="badge-icon">üîí</div>
                        <div class="badge-name">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div class="card">
                <h2>üèÜ Recent Achievements</h2>
                <div class="achievement-list" id="achievementsList">
                    <div class="achievement-item">
                        <div class="achievement-icon">‚è≥</div>
                        <div class="achievement-details">
                            <div class="achievement-title">Loading achievements...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mini Leaderboard -->
            <div class="card">
                <h2>ü•á Top Learners</h2>
                <div class="leaderboard-list" id="leaderboardList">
                    <div class="leaderboard-item">
                        <div class="rank">üèÉ</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activities Section -->
        <div class="activity-section">
            <h2>üìö Learning Activities</h2>
            <div class="activity-grid">
                <div class="activity-card" onclick="startActivity('counting-adventure')">
                    <div class="activity-icon">üî¢</div>
                    <div class="activity-name">Counting Adventure</div>
                    <div class="activity-stats">Learn to count</div>
                </div>
                <div class="activity-card" onclick="startActivity('number-recognition')">
                    <div class="activity-icon">üéØ</div>
                    <div class="activity-name">Number Recognition</div>
                    <div class="activity-stats">Identify numbers</div>
                </div>
                <div class="activity-card" onclick="startActivity('basic-math')">
                    <div class="activity-icon">‚ûï</div>
                    <div class="activity-name">Basic Math</div>
                    <div class="activity-stats">Simple arithmetic</div>
                </div>
                <div class="activity-card" onclick="startActivity('alphabet-learning')">
                    <div class="activity-icon">üî§</div>
                    <div class="activity-name">Alphabet Learning</div>
                    <div class="activity-stats">Letter recognition</div>
                </div>
                <div class="activity-card" onclick="startActivity('colors-and-shapes')">
                    <div class="activity-icon">üé®</div>
                    <div class="activity-name">Colors & Shapes</div>
                    <div class="activity-stats">Learn colors and shapes</div>
                </div>
                <div class="activity-card" onclick="startActivity('phonics-and-sounds')">
                    <div class="activity-icon">üîä</div>
                    <div class="activity-name">Phonics Sounds</div>
                    <div class="activity-stats">Letter sounds & rhyming</div>
                </div>
                <div class="activity-card" onclick="startActivity('time-telling')">
                    <div class="activity-icon">‚è∞</div>
                    <div class="activity-name">Time Telling</div>
                    <div class="activity-stats">Learn to tell time</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for Activity Details -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Activity</h2>
            <p id="modalDescription">Loading activity details...</p>
            <button class="btn btn-primary" onclick="startLearningSession()">Start Learning</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Session Summary Modal -->
    <div id="sessionSummaryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 3000; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div id="summaryEmoji" style="font-size: 4em; margin-bottom: 20px;">üéâ</div>
                <h2 id="summaryTitle" style="color: #333; margin-bottom: 10px; font-size: 2em;">Session Complete!</h2>
                <p id="summaryActivityName" style="color: #666; font-size: 1.1em; margin-bottom: 20px;"></p>
            </div>

            <!-- Stats Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- Questions Answered -->
                <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #2196F3;">
                    <div style="font-size: 2.5em; color: #1976d2; font-weight: bold; margin-bottom: 5px;" id="questionsAnswered">0</div>
                    <div style="color: #1976d2; font-size: 0.9em;">Questions Answered</div>
                </div>

                <!-- Accuracy -->
                <div style="background: #f3e5f5; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #9c27b0;">
                    <div style="font-size: 2.5em; color: #6a1b9a; font-weight: bold; margin-bottom: 5px;" id="accuracyDisplay">0%</div>
                    <div style="color: #6a1b9a; font-size: 0.9em;">Accuracy</div>
                </div>

                <!-- Time Spent -->
                <div style="background: #fff3e0; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #ff9800;">
                    <div style="font-size: 2.5em; color: #e65100; font-weight: bold; margin-bottom: 5px;" id="timeSpent">0m 0s</div>
                    <div style="color: #e65100; font-size: 0.9em;">Time Spent</div>
                </div>

                <!-- XP Earned -->
                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #4caf50;">
                    <div style="font-size: 2.5em; color: #2e7d32; font-weight: bold; margin-bottom: 5px;" id="xpEarned">0 XP</div>
                    <div style="color: #2e7d32; font-size: 0.9em;">XP Earned</div>
                </div>
            </div>

            <!-- Correct/Incorrect Breakdown -->
            <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">üìä Performance Breakdown</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="color: #4caf50; font-weight: bold;">‚úÖ</span>
                            <span id="correctCount" style="color: #333; font-weight: bold;">0</span>
                            <span style="color: #666;">Correct</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px;">
                            <div id="correctBar" style="width: 0%; height: 100%; background: #4caf50; border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="color: #f44336; font-weight: bold;">‚ùå</span>
                            <span id="incorrectCount" style="color: #333; font-weight: bold;">0</span>
                            <span style="color: #666;">Incorrect</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px;">
                            <div id="incorrectBar" style="width: 0%; height: 100%; background: #f44336; border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Streak & Performance Stats -->
            <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">üî• Streak & Performance</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #ff6f00;">
                        <div style="font-size: 1.8em; color: #ff6f00; font-weight: bold;" id="maxStreakDisplay">0</div>
                        <div style="color: #666; font-size: 0.9em;">üî• Max Streak</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #2196F3;">
                        <div style="font-size: 1.8em; color: #2196F3; font-weight: bold;" id="avgTimeDisplay">0s</div>
                        <div style="color: #666; font-size: 0.9em;">‚è±Ô∏è Avg Time/Q</div>
                    </div>
                </div>
            </div>

            <!-- Time Tracking -->
            <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">‚è±Ô∏è Time Tracking</h3>
                <div id="timeTrackingList" style="display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto;">
                    <!-- Question timings will be populated here -->
                </div>
            </div>

            <!-- Topics Covered -->
            <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">üìö Topics Covered</h3>
                <div id="topicsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <!-- Topics will be populated here -->
                </div>
            </div>

            <!-- Achievement Notification -->
            <div id="achievementNotification" style="display: none; background: #fff3cd; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #ffc107;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="achievementIcon" style="font-size: 2.5em;">üèÜ</div>
                    <div>
                        <div style="color: #856404; font-weight: bold; margin-bottom: 5px;" id="achievementTitle">New Achievement!</div>
                        <div style="color: #856404; font-size: 0.9em;" id="achievementDesc">You earned a new badge!</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px;">
                <button onclick="returnToDashboard()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer;">‚Ü©Ô∏è Back to Dashboard</button>
                <button onclick="retryActivity()" style="flex: 1; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer;">üîÑ Try Again</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStudent = null;
        let currentActivity = null;

        // Mock gamification object (fallback if not loaded)
        const gamification = window.gamification || {
            ensurePlayer: (id) => ({
                xp: 0,
                level: 1,
                attempts: 0,
                correct_count: 0
            }),
            getPlayerBadges: (id) => [],
            recordActivity: () => {}
        };

        // Initialize on page load
        async function init() {
            try {
                await loadStudentData();
                await loadBadges();
                await loadAchievements();
                await loadLeaderboard();
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        }
        
        // Make gamification globally accessible
        window.gamification = gamification;

        // Initialize page on DOM content loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM already loaded
            init();
        }

        // Load student data from gamification engine
        async function loadStudentData() {
            try {
                // Get student ID from localStorage or create one
                let studentId = localStorage.getItem('studentId');
                if (!studentId) {
                    studentId = 'student_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('studentId', studentId);
                }

                // Ensure player exists in gamification engine
                const player = gamification.ensurePlayer(studentId);
                
                // Calculate accuracy from attempts
                const accuracy = player.attempts > 0 
                    ? Math.round((player.correct_count / player.attempts) * 100)
                    : 0;

                // Update UI with gamification data
                document.getElementById('studentName').textContent = 'Default Learner';
                document.getElementById('sessionsCount').textContent = player.attempts || 0;
                document.getElementById('accuracyCount').textContent = accuracy + '%';
                document.getElementById('xpCount').textContent = player.xp;

                // Calculate level and XP progress
                const level = player.level;
                const nextLevelXp = Math.ceil(Math.sqrt((level + 1) * 10 * 100)); // next level XP
                const currentLevelXp = Math.ceil(Math.sqrt(level * 10 * 100)); // current level start
                const xpInLevel = player.xp - currentLevelXp;
                const xpForThisLevel = nextLevelXp - currentLevelXp;
                const xpPercent = Math.round((xpInLevel / xpForThisLevel) * 100);

                document.getElementById('levelDisplay').textContent = `Level ${level}`;
                document.getElementById('xpText').textContent = `${xpInLevel} / ${xpForThisLevel} XP`;
                document.getElementById('xpFill').style.width = Math.min(xpPercent, 100) + '%';
                document.getElementById('xpPercent').textContent = Math.min(xpPercent, 100) + '%';

                currentStudent = { id: studentId, ...player, accuracy };
            } catch (error) {
                console.error('Error loading student data:', error);
            }
        }

        // Define all available badges with rarity levels
        const allBadges = {
            'streak-3': {
                icon: 'üî•',
                name: '3x Hot',
                desc: 'Get 3 correct answers in a row',
                rarity: 'common',
                xp: 10
            },
            'streak-5': {
                icon: 'üåü',
                name: '5x Star',
                desc: 'Get 5 correct answers in a row',
                rarity: 'uncommon',
                xp: 25
            },
            'streak-10': {
                icon: 'üöÄ',
                name: '10x Rocket',
                desc: 'Get 10 correct answers in a row',
                rarity: 'rare',
                xp: 50
            },
            'perfect-day': {
                icon: 'üíØ',
                name: 'Perfect Day',
                desc: 'Achieve 100% accuracy in a session',
                rarity: 'epic',
                xp: 75
            },
            'dedicated': {
                icon: 'üëë',
                name: 'Dedicated',
                desc: 'Maintain a 7-day learning streak',
                rarity: 'legendary',
                xp: 100
            },
            'daily-master': {
                icon: 'üéÅ',
                name: 'Daily Master',
                desc: 'Win 5 daily challenges',
                rarity: 'epic',
                xp: 75
            }
        };

        // Get badge icon based on type
        function getBadgeIcon(id) {
            return allBadges[id]?.icon || '‚≠ê';
        }

        // Load badges from gamification engine with enhanced display
        async function loadBadges() {
            try {
                const studentId = localStorage.getItem('studentId');
                if (!studentId) return;

                // Get earned badges from gamification engine
                const earnedBadges = gamification.getPlayerBadges(studentId) || [];
                const earnedBadgeIds = earnedBadges.map(b => b.id || b);
                const badgesContainer = document.getElementById('badgesContainer');
                
                // Update badge statistics
                const totalBadges = Object.keys(allBadges).length;
                const earnedCount = earnedBadgeIds.length;
                const completionPercent = Math.round((earnedCount / totalBadges) * 100);
                
                document.getElementById('badgesEarned').textContent = earnedCount;
                document.getElementById('badgesTotal').textContent = totalBadges;
                document.getElementById('badgeCompletionPercent').textContent = completionPercent + '%';
                document.getElementById('badgeCompletionFill').style.width = completionPercent + '%';

                badgesContainer.innerHTML = '';

                // Display all badges (earned first, then locked)
                const displayedBadges = new Set();

                // First, show earned badges
                earnedBadgeIds.forEach(badgeId => {
                    const badgeInfo = allBadges[badgeId];
                    if (badgeInfo && !displayedBadges.has(badgeId)) {
                        const badgeEl = createBadgeElement(badgeId, badgeInfo, true);
                        badgesContainer.appendChild(badgeEl);
                        displayedBadges.add(badgeId);
                    }
                });

                // Then, show locked badges
                Object.keys(allBadges).forEach(badgeId => {
                    if (!displayedBadges.has(badgeId)) {
                        const badgeInfo = allBadges[badgeId];
                        const badgeEl = createBadgeElement(badgeId, badgeInfo, false);
                        badgesContainer.appendChild(badgeEl);
                    }
                });

                if (earnedCount === 0) {
                    badgesContainer.innerHTML = '<p style="color: #999; grid-column: 1/-1; text-align: center;">No badges earned yet. Complete activities to unlock badges! üéØ</p>';
                }
            } catch (error) {
                console.error('Error loading badges:', error);
                document.getElementById('badgesContainer').innerHTML = '<p style="color: #999;">Error loading badges</p>';
            }
        }

        // Create a badge element with enhanced styling
        function createBadgeElement(badgeId, badgeInfo, isEarned) {
            const badgeEl = document.createElement('div');
            const rarityClass = `rarity-${badgeInfo.rarity}`;
            const lockedClass = isEarned ? '' : 'locked';
            
            badgeEl.className = `badge ${rarityClass} ${lockedClass}`;
            badgeEl.style.cursor = 'pointer';
            
            const unlockText = isEarned ? `+${badgeInfo.xp} XP` : 'Locked';
            
            badgeEl.innerHTML = `
                <div class="badge-icon">${badgeInfo.icon}</div>
                <div class="badge-name">${badgeInfo.name}</div>
                <div class="badge-rarity">${badgeInfo.rarity}</div>
                <div class="badge-date">${unlockText}</div>
                <div class="badge-tooltip">
                    <strong>${badgeInfo.name}</strong><br>
                    ${badgeInfo.desc}
                </div>
            `;

            // Add click handler to show detailed info
            badgeEl.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log('Badge clicked:', badgeId); // Debug
                showBadgeDetails(badgeId, badgeInfo, isEarned);
            });

            return badgeEl;
        }

        // Show detailed badge information
        function showBadgeDetails(badgeId, badgeInfo, isEarned) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease;
            `;

            const statusColor = isEarned ? '#4caf50' : '#999';
            const statusText = isEarned ? '‚úì Unlocked' : 'üîí Locked';

            content.innerHTML = `
                <style>
                    @keyframes modalSlideIn {
                        from {
                            opacity: 0;
                            transform: scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1);
                        }
                    }
                </style>
                <div style="font-size: 4em; margin-bottom: 15px;">${badgeInfo.icon}</div>
                <h2 style="color: #333; margin: 0 0 10px 0; font-size: 1.8em;">${badgeInfo.name}</h2>
                <p style="color: ${statusColor}; font-weight: bold; font-size: 1.1em; margin-bottom: 15px;">${statusText}</p>
                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <p style="color: #666; margin: 0; font-size: 0.95em;">${badgeInfo.desc}</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 8px;">
                        <div style="color: #1976d2; font-weight: bold;">Rarity</div>
                        <div style="color: #666; text-transform: capitalize;">${badgeInfo.rarity}</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 10px; border-radius: 8px;">
                        <div style="color: #388e3c; font-weight: bold;">Reward</div>
                        <div style="color: #666;">${badgeInfo.xp} XP</div>
                    </div>
                </div>
                <button id="badgeCloseBtn" style="
                    width: 100%;
                    padding: 12px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 1em;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">Close</button>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Close button handler
            const closeBtn = content.querySelector('#badgeCloseBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.remove();
                });
            }

            // Click outside modal to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Load achievements
        async function loadAchievements() {
            const achievements = [
                { icon: 'üéØ', title: 'First Steps', desc: 'Complete your first activity', progress: '1/1' },
                { icon: 'üî•', title: '3-Day Streak', desc: 'Learn for 3 days in a row', progress: '2/3' },
                { icon: 'üíØ', title: 'Perfect Score', desc: 'Score 100% on an activity', progress: '0/1' },
                { icon: 'üöÄ', title: 'Speed Demon', desc: 'Complete an activity in under 2 minutes', progress: '1/3' }
            ];

            const list = document.getElementById('achievementsList');
            list.innerHTML = achievements.map(a => `
                <div class="achievement-item">
                    <div class="achievement-icon">${a.icon}</div>
                    <div class="achievement-details">
                        <div class="achievement-title">${a.title}</div>
                        <div class="achievement-desc">${a.desc}</div>
                    </div>
                    <div class="achievement-progress">${a.progress}</div>
                </div>
            `).join('');
        }

        // Load leaderboard
        async function loadLeaderboard() {
            const leaderboard = [
                { rank: 1, name: 'Emma', xp: 450 },
                { rank: 2, name: 'Lucas', xp: 380 },
                { rank: 3, name: 'Sophia', xp: 320 }
            ];

            const list = document.getElementById('leaderboardList');
            list.innerHTML = leaderboard.map(item => {
                let rankColor = '';
                if (item.rank === 1) rankColor = 'gold';
                else if (item.rank === 2) rankColor = 'silver';
                else if (item.rank === 3) rankColor = 'bronze';

                return `
                    <div class="leaderboard-item">
                        <div class="rank ${rankColor}">#${item.rank}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${item.name}</div>
                        </div>
                        <div class="leaderboard-xp">${item.xp} XP</div>
                    </div>
                `;
            }).join('');
        }
        // Start activity (simplified)
        // Session tracking object
        const sessionState = {
            activityId: null,
            activityName: null,
            startTime: null,
            endTime: null,
            questionsAnswered: 0,
            questionsCorrect: 0,
            questionsIncorrect: 0,
            totalXpEarned: 0,
            topics: [],
            achievements: [],
            launcher: null,
            // Difficulty adaptation tracking
            currentDifficulty: 2, // 1=Easy, 2=Medium, 3=Hard
            consecutiveCorrect: 0,
            consecutiveIncorrect: 0,
            difficultyChanges: [],
            // Session features tracking
            questionStartTime: null,
            questionTimings: [], // Array of { questionId, timeSeconds, isCorrect }
            maxStreak: 0, // Highest streak achieved
            dailyChallengeAttempts: 0, // Number of daily challenge questions
            dailyChallengeCorrect: 0, // Correct daily challenge answers
            dailyChallengeXp: 0 // XP from daily challenges
        };

        // Show difficulty selection modal
        function showDifficultySelector(activityId) {
            return new Promise((resolve) => {
                const html = `
                    <div id="difficultyOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 3000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 30px 90px rgba(0, 0, 0, 0.5);">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <h2 style="color: #333; font-size: 1.8em; margin-bottom: 10px;">üéØ Choose Your Difficulty Level</h2>
                                <p style="color: #666; font-size: 0.95em;">Select how challenging you want the activity to be. You can change it anytime!</p>
                            </div>
                            
                            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-direction: column;">
                                <button class="difficulty-btn" data-level="easy" style="padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; text-align: left;">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">üå± Easy</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">Simple questions, more time to answer</div>
                                </button>
                                
                                <button class="difficulty-btn" data-level="medium" style="padding: 20px; background: linear-gradient(135deg, #2196F3 0%, #1976d2 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; text-align: left;">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">üéØ Medium</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">Balanced difficulty (Recommended)</div>
                                </button>
                                
                                <button class="difficulty-btn" data-level="hard" style="padding: 20px; background: linear-gradient(135deg, #ff6f00 0%, #e55100 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; text-align: left;">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">üöÄ Hard</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">Challenging questions, minimal hints</div>
                                </button>
                            </div>
                            
                            <p style="color: #999; font-size: 0.8em; text-align: center; margin-top: 20px;">üí° Tip: The system will automatically adjust difficulty based on your performance!</p>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
                
                // Add event listeners to buttons
                const buttons = document.querySelectorAll('.difficulty-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const level = this.getAttribute('data-level');
                        console.log('Difficulty button clicked:', level);
                        selectDifficulty(level, activityId);
                        resolve(level);
                    });
                });
                
                window._difficultyResolve = resolve;
            });
        }

        function selectDifficulty(level, activityId) {
            const difficultyMap = { 'easy': 1, 'medium': 2, 'hard': 3 };
            const difficulty = difficultyMap[level];
            
            console.log(`üìà Difficulty selected: ${level} (Level ${difficulty})`);
            sessionState.currentDifficulty = difficulty;
            
            // Close modal
            const overlay = document.getElementById('difficultyOverlay');
            if (overlay) overlay.remove();
            
            // Announce selection
            const difficultyNames = { 1: 'Easy', 2: 'Medium', 3: 'Hard' };
            speakText(`You selected ${difficultyNames[difficulty]} difficulty. Let's start!`);
            
            // Resume activity with selected difficulty
            if (window._difficultyResolve) {
                window._difficultyResolve(difficulty);
            }
        }

        window.selectDifficulty = selectDifficulty;

        // Check if a question is a daily challenge
        function isDailyChallenge(questionId, questionIndex) {
            // Daily challenges rotate: every 5th question on specific days
            const now = new Date();
            const dayOfWeek = now.getDay();
            const dailySeed = dayOfWeek + Math.floor(now.getTime() / (1000 * 60 * 60 * 24)); // Changes daily
            
            // Hash-based selection: roughly 20% of questions are daily challenges
            const hash = questionId.split('').reduce((a, b) => a + b.charCodeAt(0), dailySeed) % 5;
            return hash === 0; // 1 in 5 chance
        }

        async function startActivity(activityId) {
            try {
                console.log(`üéÆ Starting activity: ${activityId}`);
                
                // Show alert for now - activity system will be integrated later
                alert(`Activity: ${activityId}\n\nThis feature will be integrated with the activity system.`);
                
            } catch (error) {
                console.error('Error starting activity:', error);
                alert('Could not start activity. Please try again.');
            }
        }

        // Placeholder functions for activity system
        async function showActivityInterface(launcher) {
            // Placeholder - activity interface will be integrated later
            console.log('Activity interface placeholder');
        }

        // Placeholder voice configuration
        const voiceConfig = {
            timeout: 15000,           // 15 seconds
            confidence: 0.6,          // 60% confidence threshold
            language: 'en-US',
            maxAttempts: 3,
            autoRetry: true,
            feedbackVoice: true
        };

        // Listen for voice answer - Enhanced version
        function listenForVoiceAnswer() {
            console.log('üé§ Starting voice listening...');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition not supported. Please use Chrome, Edge, or Firefox.');
                return;
            }
            
            const launcher = window.activityLauncher;
            const question = window.activityQuestion;
            const statusText = document.getElementById('voiceStatusText');
            const listenButton = document.querySelector('button[onclick="listenForVoiceAnswer()"]');
            
            // Disable button while listening
            if (listenButton) listenButton.disabled = true;
            
            // Update status with visual feedback
            if (statusText) {
                statusText.textContent = 'üé§ Listening... Speak clearly and wait for silence';
                statusText.style.color = '#1976d2';
                statusText.style.animation = 'pulse 1s infinite';
            }
            
            // Add pulse animation if not exists
            if (!document.getElementById('voicePulseStyle')) {
                const style = document.createElement('style');
                style.id = 'voicePulseStyle';
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.6; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Create recognition object with enhanced settings
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = voiceConfig.language;
            recognition.maxAlternatives = 3;  // Get multiple alternatives
            
            let finalTranscript = '';
            let interimTranscript = '';
            let confidence = 0;
            let answered = false;
            let listeningStartTime = Date.now();
            let lastSpeechTime = Date.now();
            
            recognition.onstart = () => {
                console.log('‚úì Speech recognition started');
                console.log('üîä Speak your answer now - waiting for speech...');
                finalTranscript = '';
                interimTranscript = '';
                lastSpeechTime = Date.now();
                
                // Update status with countdown
                if (statusText) {
                    statusText.innerHTML = 'üé§ Listening...<br><span style="font-size: 0.9em;">Waiting for your voice...</span>';
                }
            };
            
            recognition.onresult = (event) => {
                interimTranscript = '';
                let bestConfidence = 0;
                let bestTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    const conf = event.results[i][0].confidence;
                    
                    if (conf > bestConfidence) {
                        bestConfidence = conf;
                        bestTranscript = transcript;
                    }
                    
                    if (event.results[i].isFinal) {
                        finalTranscript = transcript.toLowerCase().trim();
                        confidence = Math.round(conf * 100);
                        console.log(`‚úÖ Final: "${finalTranscript}" (${confidence}% confidence)`);
                        lastSpeechTime = Date.now();
                        
                        // Update status with confidence
                        if (statusText) {
                            const confidenceBar = '‚ñà'.repeat(Math.floor(confidence / 10)) + '‚ñë'.repeat(10 - Math.floor(confidence / 10));
                            statusText.innerHTML = `üìù Heard: "${finalTranscript}"<br><span style="font-size: 0.85em;">Confidence: ${confidenceBar} ${confidence}%</span>`;
                        }
                    } else {
                        interimTranscript += transcript;
                        console.log(`üìù Interim: "${bestTranscript}" (${Math.round(bestConfidence * 100)}% confidence)`);
                        
                        // Show interim results with confidence
                        if (statusText) {
                            const interimConf = Math.round(bestConfidence * 100);
                            const interimBar = '‚ñà'.repeat(Math.floor(interimConf / 10)) + '‚ñë'.repeat(10 - Math.floor(interimConf / 10));
                            statusText.innerHTML = `üé§ Hearing: "${bestTranscript}"<br><span style="font-size: 0.85em;">Confidence: ${interimBar} ${interimConf}%</span>`;
                        }
                    }
                }
            };
            
            recognition.onerror = (event) => {
                console.error(`‚ùå Voice error: ${event.error}`);
                
                // Friendly error messages
                let errorMsg = '';
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = '‚ö†Ô∏è No speech detected. Speak louder or try again.';
                        break;
                    case 'audio-capture':
                        errorMsg = '‚ö†Ô∏è Microphone not working. Check permissions.';
                        break;
                    case 'network':
                        errorMsg = '‚ö†Ô∏è Network error. Check connection.';
                        break;
                    default:
                        errorMsg = `‚ö†Ô∏è Error: ${event.error}. Try again.`;
                }
                
                if (statusText) {
                    statusText.textContent = errorMsg;
                    statusText.style.color = '#d32f2f';
                    statusText.style.animation = 'none';
                }
                if (listenButton) listenButton.disabled = false;
                
                // Speak error message for accessibility
                if (voiceConfig.feedbackVoice) {
                    speakText('Please try again');
                }
            };
            
            recognition.onend = () => {
                console.log('‚èπÔ∏è Speech recognition ended');
                
                // Remove animation
                if (statusText) {
                    statusText.style.animation = 'none';
                }
                
                if (!answered && finalTranscript) {
                    answered = true;
                    
                    // Check confidence threshold
                    if (confidence < voiceConfig.confidence * 100) {
                        console.warn(`‚ö†Ô∏è Low confidence (${confidence}%), confirming with user...`);
                        if (statusText) {
                            statusText.innerHTML = `üìù Heard: "${finalTranscript}" (${confidence}% confidence)<br><span style="font-size: 0.85em; color: #ff9800;">Is this correct? Try again if not.</span>`;
                        }
                    } else {
                        if (statusText) {
                            statusText.innerHTML = `‚úÖ Processing: "${finalTranscript}"<br><span style="font-size: 0.85em;">Confidence: ${confidence}%</span>`;
                        }
                    }
                    
                    // Process the answer
                    console.log(`‚úÖ Processing answer: "${finalTranscript}"`);
                    processVoiceAnswer(finalTranscript, launcher, question);
                } else if (!finalTranscript) {
                    if (statusText) {
                        statusText.textContent = '‚ö†Ô∏è No speech detected. Click to try again.';
                        statusText.style.color = '#ff9800';
                    }
                    
                    // Speak message for accessibility
                    if (voiceConfig.feedbackVoice) {
                        speakText('I did not hear anything. Please try again.');
                    }
                }
                
                if (listenButton) listenButton.disabled = false;
            };
            
            // Start listening with timeout
            try {
                recognition.start();
                console.log('üì• Recognition started, waiting for speech...');
                console.log(`‚è±Ô∏è Timeout: ${voiceConfig.timeout / 1000} seconds`);
                
                // Auto-stop after timeout
                setTimeout(() => {
                    if (recognition && !answered) {
                        console.log('‚è±Ô∏è Timeout reached, stopping recognition');
                        recognition.stop();
                    }
                }, voiceConfig.timeout);
                
            } catch (e) {
                console.error('Error starting recognition:', e);
                if (statusText) {
                    statusText.textContent = `‚ùå Error: ${e.message}`;
                    statusText.style.color = '#d32f2f';
                }
                if (listenButton) listenButton.disabled = false;
            }
        }
        
        // Process the voice answer
        async function processVoiceAnswer(answer, launcher, question) {
            console.log(`üìù Processing answer: "${answer}"`);
            
            try {
                // Check the answer
                const isCorrect = launcher.checkAnswer(question, answer);
                let xpEarned = launcher.calculateXP(isCorrect, 5);
                
                // Check if this is a daily challenge and boost XP
                const isDailyChall = isDailyChallenge(question.id, launcher.currentQuestionIndex);
                if (isDailyChall && isCorrect) {
                    const bonusXp = Math.floor(xpEarned * 0.5); // 50% bonus
                    xpEarned += bonusXp;
                    sessionState.dailyChallengeCorrect++;
                    sessionState.dailyChallengeXp += bonusXp;
                }
                if (isDailyChall) {
                    sessionState.dailyChallengeAttempts++;
                }
                
                console.log(`Answer check: ${isCorrect ? '‚úÖ CORRECT' : '‚ùå WRONG'}`);
                if (isDailyChall && isCorrect) {
                    console.log(`üåü Daily Challenge! +${Math.floor(xpEarned * 0.5)} bonus XP`);
                }
                
                // Calculate question response time
                const questionTime = (Date.now() - sessionState.questionStartTime) / 1000;
                
                // Track session statistics
                sessionState.questionsAnswered++;
                if (isCorrect) {
                    sessionState.questionsCorrect++;
                    sessionState.totalXpEarned += xpEarned;
                    // Track consecutive correct answers
                    sessionState.consecutiveCorrect++;
                    sessionState.consecutiveIncorrect = 0;
                } else {
                    sessionState.questionsIncorrect++;
                    // Track consecutive incorrect answers
                    sessionState.consecutiveIncorrect++;
                    sessionState.consecutiveCorrect = 0;
                }
                
                // Track max streak
                if (sessionState.consecutiveCorrect > sessionState.maxStreak) {
                    sessionState.maxStreak = sessionState.consecutiveCorrect;
                }
                
                // Record question timing
                sessionState.questionTimings.push({
                    questionId: question.id,
                    timeSeconds: Math.round(questionTime * 10) / 10,
                    isCorrect: isCorrect,
                    difficulty: sessionState.currentDifficulty
                });
                
                // Update streak display
                updateStreakDisplay();
                
                // Check for difficulty changes
                checkAndUpdateDifficulty();
                
                // Record response
                await launcher.recordResponse(question, answer, 5);
                
                // Update gamification and capture achievement results
                let achievementTriggered = null;
                let newBadgeInfo = null;
                if (window.gamification && isCorrect) {
                    const studentId = localStorage.getItem('studentId');
                    const playerBefore = window.gamification.getPlayer(studentId);
                    const levelBefore = playerBefore.level;
                    const badgesBefore = (playerBefore.badges || []).length;
                    
                    // Award XP (returns { player, leveledUp, newBadges })
                    const result = window.gamification.awardXP(studentId, xpEarned);
                    
                    // Check for level up
                    if (result.leveledUp) {
                        console.log('üéâ LEVEL UP!');
                        achievementTriggered = 'level';
                        sessionState.achievements.push({
                            type: 'level',
                            title: `Level ${result.player.level}`,
                            description: 'You advanced to a new level!'
                        });
                    }
                    // Check for new badges
                    else if (result.newBadges && result.newBadges.length > 0) {
                        console.log('üèÜ Badge earned:', result.newBadges[0]);
                        newBadgeInfo = result.newBadges[0];
                        achievementTriggered = result.newBadges[0].id || 'badge';
                        
                        // Store achievement
                        sessionState.achievements.push({
                            type: 'badge',
                            title: result.newBadges[0].name,
                            description: result.newBadges[0].description,
                            icon: result.newBadges[0].icon
                        });
                        
                        // Map badge IDs to sound types
                        if (achievementTriggered.includes('streak')) {
                            achievementTriggered = 'streak';
                        } else if (achievementTriggered.includes('accuracy')) {
                            achievementTriggered = 'accuracy';
                        }
                    }
                }
                
                // Show feedback
                const feedback = document.getElementById('activityFeedback');
                if (feedback) {
                    feedback.style.display = 'block';
                    
                    if (isCorrect) {
                        feedback.style.background = '#d4edda';
                        feedback.style.color = '#155724';
                        feedback.style.borderLeft = '4px solid #4caf50';
                        feedback.textContent = `‚úÖ Correct! +${xpEarned} XP`;
                        
                        // Play success sound first, then achievement sound if applicable
                        playSuccessSound();
                        
                        // If achievement triggered, play that sound after a short delay
                        if (achievementTriggered) {
                            setTimeout(() => {
                                playAchievementSound(achievementTriggered);
                                // Announce achievement
                                const achievementMsg = getAchievementMessage(achievementTriggered);
                                speakText(achievementMsg);
                            }, 600);
                        } else {
                            // Speak congratulations
                            speakText('Correct! Great job!');
                        }
                        
                        // Check for level up (for logging)
                        if (window.gamification) {
                            const studentId = localStorage.getItem('studentId');
                            const player = window.gamification.getPlayer(studentId);
                            console.log(`Current level: ${player.level}`);
                        }
                        
                        // Auto-move to next question after 2 seconds
                        console.log('‚è≠Ô∏è Moving to next question in 2 seconds...');
                        setTimeout(() => {
                            nextActivityQuestion();
                        }, 2000);
                    } else {
                        feedback.style.background = '#f8d7da';
                        feedback.style.color = '#721c24';
                        feedback.style.borderLeft = '4px solid #f44336';
                        feedback.textContent = `‚ùå Not quite right. The answer is: ${question.expectedAnswers[0]}`;
                        
                        // Play error sound
                        playErrorSound();
                        
                        // Speak correct answer
                        speakText(`The correct answer is ${question.expectedAnswers[0]}`);
                    }
                }
                
            } catch (error) {
                console.error('Error processing voice answer:', error);
                const feedback = document.getElementById('activityFeedback');
                if (feedback) {
                    feedback.style.display = 'block';
                    feedback.style.background = '#f8d7da';
                    feedback.style.color = '#721c24';
                    feedback.textContent = `Error: ${error.message}`;
                }
            }
        }
        
        // Update visual streak display
        function updateStreakDisplay() {
            const correctDisplay = document.getElementById('correctStreak');
            const incorrectDisplay = document.getElementById('incorrectStreak');
            
            if (correctDisplay) correctDisplay.textContent = sessionState.consecutiveCorrect;
            if (incorrectDisplay) incorrectDisplay.textContent = sessionState.consecutiveIncorrect;
        }
        
        // Check and update difficulty based on consecutive answers
        function checkAndUpdateDifficulty() {
            const currentDifficulty = sessionState.currentDifficulty;
            let newDifficulty = currentDifficulty;
            let difficultyMessage = null;
            
            // Increase difficulty after 3 correct answers in a row
            if (sessionState.consecutiveCorrect >= 3 && currentDifficulty < 3) {
                newDifficulty = currentDifficulty + 1;
                sessionState.consecutiveCorrect = 0; // Reset counter
                difficultyMessage = 'Great job! Difficulty increased! üìà';
                console.log('üìà Difficulty increased due to 3 consecutive correct answers');
            }
            
            // Decrease difficulty after 2 wrong answers in a row
            if (sessionState.consecutiveIncorrect >= 2 && currentDifficulty > 1) {
                newDifficulty = currentDifficulty - 1;
                sessionState.consecutiveIncorrect = 0; // Reset counter
                difficultyMessage = 'Let\'s make it easier. Difficulty decreased! üìâ';
                console.log('üìâ Difficulty decreased due to 2 consecutive incorrect answers');
            }
            
            // If difficulty changed, update and announce
            if (newDifficulty !== currentDifficulty) {
                const difficultyLabels = { 1: 'Easy', 2: 'Medium', 3: 'Hard' };
                const oldLabel = difficultyLabels[currentDifficulty];
                const newLabel = difficultyLabels[newDifficulty];
                
                sessionState.currentDifficulty = newDifficulty;
                sessionState.difficultyChanges.push({
                    from: currentDifficulty,
                    to: newDifficulty,
                    timestamp: Date.now(),
                    message: difficultyMessage
                });
                
                // Update launcher difficulty
                if (window.activityLauncher) {
                    window.activityLauncher.currentLevel = newDifficulty;
                    console.log(`Launcher difficulty updated to: ${newDifficulty}`);
                }
                
                // Show difficulty change notification
                showDifficultyNotification(newLabel, difficultyMessage);
                
                // Announce difficulty change
                setTimeout(() => {
                    speakText(difficultyMessage + ` You are now on ${newLabel} difficulty.`);
                }, 1000);
            }
        }
        
        // Show difficulty change notification
        function showDifficultyNotification(newDifficulty, message) {
            const difficultyColors = {
                'Easy': '#4CAF50',
                'Medium': '#2196F3',
                'Hard': '#ff6f00'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${difficultyColors[newDifficulty]};
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 5000;
                font-weight: bold;
                font-size: 0.95em;
                animation: slideIn 0.5s ease-out;
                max-width: 300px;
                text-align: center;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            if (!document.getElementById('difficultyNotificationStyles')) {
                style.id = 'difficultyNotificationStyles';
                document.head.appendChild(style);
            }
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-out forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Get achievement announcement message
        function getAchievementMessage(achievementType) {
            const messages = {
                'level': 'Congratulations! You leveled up!',
                'badge': 'You earned a badge!',
                'starter': 'Getting started! First activity complete!',
                'streak-3': 'Three day streak! You are on fire!',
                'accuracy-90': 'Ninety percent accuracy! You are a master!',
                'speedy': 'Speedy solver! Lightning fast!',
                'streak': 'Streak achievement! Keep it up!',
                'accuracy': 'Perfect accuracy! Incredible!',
                'perfect': 'Perfect score! Amazing!'
            };
            return messages[achievementType] || 'Achievement unlocked!';
        }
        
        // Check answer (legacy - kept for compatibility)
        async function checkActivityAnswer() {
            console.log('checkActivityAnswer called');
            // Voice version uses listenForVoiceAnswer instead
            await listenForVoiceAnswer();
        }
        
        // Next question
        function nextActivityQuestion() {
            const launcher = window.activityLauncher;
            launcher.currentQuestionIndex++;
            
            const overlay = document.getElementById('activityOverlay');
            if (overlay) overlay.remove();
            
            showActivityInterface(launcher);
        }
        
        // Close activity interface and show session summary
        function closeActivityInterface() {
            const overlay = document.getElementById('activityOverlay');
            if (overlay) overlay.remove();
            
            // Show session summary instead of reloading immediately
            sessionState.endTime = Date.now();
            showSessionSummary();
        }
        
        // Show session summary modal
        function showSessionSummary() {
            const modal = document.getElementById('sessionSummaryModal');
            if (!modal) return;
            
            // Calculate statistics
            const duration = sessionState.endTime - sessionState.startTime;
            const durationSeconds = Math.floor(duration / 1000);
            const minutes = Math.floor(durationSeconds / 60);
            const seconds = durationSeconds % 60;
            const accuracy = sessionState.questionsAnswered > 0 
                ? Math.round((sessionState.questionsCorrect / sessionState.questionsAnswered) * 100)
                : 0;
            
            // Calculate average time per question
            let avgTime = 0;
            if (sessionState.questionTimings && sessionState.questionTimings.length > 0) {
                const totalTime = sessionState.questionTimings.reduce((sum, q) => sum + q.timeSeconds, 0);
                avgTime = Math.round((totalTime / sessionState.questionTimings.length) * 10) / 10;
            }
            
            // Update modal with stats
            document.getElementById('summaryActivityName').textContent = sessionState.activityName || 'Activity';
            document.getElementById('questionsAnswered').textContent = sessionState.questionsAnswered;
            document.getElementById('accuracyDisplay').textContent = accuracy + '%';
            document.getElementById('timeSpent').textContent = `${minutes}m ${seconds}s`;
            document.getElementById('xpEarned').textContent = sessionState.totalXpEarned + ' XP';
            document.getElementById('correctCount').textContent = sessionState.questionsCorrect;
            document.getElementById('incorrectCount').textContent = sessionState.questionsIncorrect;
            
            // Update progress bars
            const total = sessionState.questionsAnswered || 1;
            document.getElementById('correctBar').style.width = (sessionState.questionsCorrect / total * 100) + '%';
            document.getElementById('incorrectBar').style.width = (sessionState.questionsIncorrect / total * 100) + '%';
            
            // Update streak stats
            document.getElementById('maxStreakDisplay').textContent = sessionState.maxStreak + 'üî•';
            document.getElementById('avgTimeDisplay').textContent = avgTime + 's';
            
            // Display question timings with details
            const timeTrackingList = document.getElementById('timeTrackingList');
            if (sessionState.questionTimings && sessionState.questionTimings.length > 0) {
                const timingHtml = sessionState.questionTimings.map((timing, index) => {
                    const statusColor = timing.isCorrect ? '#4caf50' : '#f44336';
                    const statusEmoji = timing.isCorrect ? '‚úÖ' : '‚ùå';
                    const difficultyLabel = { 1: 'üå±', 2: 'üéØ', 3: 'üöÄ' }[timing.difficulty] || '?';
                    
                    return `
                        <div style="background: white; padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; border-left: 3px solid ${statusColor};">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333;">Q${index + 1} ${statusEmoji}</div>
                            </div>
                            <div style="color: #666; font-size: 0.9em;">‚è±Ô∏è ${timing.timeSeconds}s</div>
                            <div style="color: #666; font-size: 0.85em; margin-left: 10px;">${difficultyLabel}</div>
                        </div>
                    `;
                }).join('');
                timeTrackingList.innerHTML = timingHtml;
            } else {
                timeTrackingList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">No timing data</div>';
            }
            
            // Show topics covered
            const topicsList = document.getElementById('topicsList');
            if (sessionState.topics && sessionState.topics.length > 0) {
                topicsList.innerHTML = sessionState.topics
                    .map(topic => `<span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 20px; font-size: 0.85em;">üìö ${topic}</span>`)
                    .join('');
            } else {
                topicsList.innerHTML = '<span style="color: #999;">Topics not specified</span>';
            }
            
            // Show achievement notification if earned
            const achievementNotif = document.getElementById('achievementNotification');
            if (sessionState.achievements && sessionState.achievements.length > 0) {
                const achievement = sessionState.achievements[0];
                achievementNotif.style.display = 'flex';
                
                if (achievement.type === 'level') {
                    document.getElementById('achievementIcon').textContent = '‚≠ê';
                    document.getElementById('achievementTitle').textContent = achievement.title;
                    document.getElementById('achievementDesc').textContent = achievement.description;
                } else if (achievement.type === 'badge') {
                    document.getElementById('achievementIcon').textContent = achievement.icon || 'üèÜ';
                    document.getElementById('achievementTitle').textContent = achievement.title;
                    document.getElementById('achievementDesc').textContent = achievement.description;
                }
            } else {
                achievementNotif.style.display = 'none';
            }
            
            // ========== ACHIEVEMENT SYSTEM INTEGRATION ==========
            // Record session to leaderboard
            const studentId = localStorage.getItem('studentId');
            const studentName = localStorage.getItem('studentName') || 'Student';
            if (studentId) {
                recordTodaysSession(studentId, studentName, sessionState.totalXpEarned, accuracy / 100, sessionState.maxStreak, timeSpent);
            }
            
            // Check and award achievements
            const studentData = {
                totalXP: sessionState.totalXpEarned,
                activitiesCompleted: (parseInt(localStorage.getItem('activitiesCompleted') || '0')) + 1,
                maxStreak: sessionState.maxStreak,
                dailyChallengesSolved: sessionState.dailyChallengeCorrect || 0
            };
            
            const sessionData = {
                accuracy: accuracy / 100,
                timeSpent: timeSpent,
                maxStreak: sessionState.maxStreak
            };
            
            // Check for new achievements
            const newAchievements = checkAndAwardAchievements(studentData, sessionData);
            
            // Save updated activities count
            localStorage.setItem('activitiesCompleted', studentData.activitiesCompleted.toString());
            
            // Award bonus XP for achievements
            let achievementBonusXP = newAchievements.reduce((total, id) => {
                return total + (achievementSystem.achievements[id]?.xp || 0);
            }, 0);
            
            if (achievementBonusXP > 0) {
                sessionState.totalXpEarned += achievementBonusXP;
                document.getElementById('xpEarned').textContent = sessionState.totalXpEarned + ' XP';
            }
            // ========== END ACHIEVEMENT INTEGRATION ==========
            
            // Show modal
            modal.style.display = 'flex';
            
            // Play celebratory sound if high accuracy
            if (accuracy >= 80) {
                setTimeout(() => {
                    playPerfectSound();
                    speakText(`Great job! You scored ${accuracy}% accuracy!`);
                }, 500);
            }
        }
        
        // Return to dashboard
        function returnToDashboard() {
            const modal = document.getElementById('sessionSummaryModal');
            if (modal) modal.style.display = 'none';
            
            // Reload to show updated stats
            setTimeout(() => {
                location.reload();
            }, 500);
        }
        
        // Retry the activity
        function retryActivity() {
            const modal = document.getElementById('sessionSummaryModal');
            if (modal) modal.style.display = 'none';
            
            // Reset session state and restart
            const activityId = sessionState.activityId;
            startActivity(activityId);
        }
            
        // Close modal
        function closeModal() {
            document.getElementById('activityModal').style.display = 'none';
        }

        // Trigger appropriate achievement sound based on type
        function playAchievementSound(achievementType = 'badge') {
            switch(achievementType) {
                case 'badge':
                    playBadgeSound();
                    break;
                case 'streak':
                    playStreakSound();
                    break;
                case 'perfect':
                case 'accuracy':
                    playPerfectSound();
                    break;
                case 'level':
                    playLevelUpSound();
                    break;
                default:
                    playBadgeSound();
            }
        }
        
        // Expose functions to global scope for onclick handlers
        window._startActivity = startActivity;
        window._showActivityInterface = showActivityInterface;
        window._checkActivityAnswer = checkActivityAnswer;
        window._listenForVoiceAnswer = listenForVoiceAnswer;
        window._nextActivityQuestion = nextActivityQuestion;
        window._closeActivityInterface = closeActivityInterface;
        window._returnToDashboard = returnToDashboard;
        window._retryActivity = retryActivity;
        
        // Expose achievement sound functions
        window._playBadgeSound = playBadgeSound;
        window._playStreakSound = playStreakSound;
        window._playPerfectSound = playPerfectSound;
        window._playLevelUpSound = playLevelUpSound;
        window._playAchievementSound = playAchievementSound;

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('activityModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // ============= ACHIEVEMENT & MILESTONE SYSTEM =============
        
        const achievementSystem = {
            // Define all achievements
            achievements: {
                'first_50xp': { icon: '‚≠ê', name: 'First Glow', desc: 'Earn your first 50 XP', xp: 10, milestone: 50 },
                'first_activity': { icon: 'üéØ', name: 'First Steps', desc: 'Complete your first activity', xp: 25, type: 'activity' },
                'perfect_score': { icon: 'üíØ', name: 'Perfect Score', desc: 'Get 100% accuracy in an activity', xp: 50, accuracy: 1.0 },
                'speed_demon': { icon: '‚ö°', name: 'Speed Demon', desc: 'Complete activity in under 2 minutes', xp: 30, timeLimit: 120 },
                'streak_3': { icon: 'üî•', name: 'On Fire!', desc: 'Get 3 correct answers in a row', xp: 15, streak: 3 },
                'streak_5': { icon: 'üåü', name: 'Blazing', desc: 'Get 5 correct answers in a row', xp: 30, streak: 5 },
                'streak_10': { icon: 'üöÄ', name: 'Unstoppable', desc: 'Get 10 correct answers in a row', xp: 60, streak: 10 },
                'daily_challenge_master': { icon: 'üéÅ', name: 'Daily Master', desc: 'Solve 5 daily challenges', xp: 40, dailyChallenges: 5 },
                'accuracy_expert': { icon: 'üéì', name: 'Accuracy Expert', desc: 'Achieve 90%+ accuracy', xp: 35, accuracy: 0.9 },
                'early_bird': { icon: 'üåÖ', name: 'Early Bird', desc: 'Complete activity before 9 AM', xp: 20, earlyMorning: true },
                'night_owl': { icon: 'üåô', name: 'Night Owl', desc: 'Complete activity after 8 PM', xp: 20, nightTime: true },
                'week_warrior': { icon: 'üí™', name: 'Week Warrior', desc: 'Learn 7 days in a row', xp: 100, weekStreak: 7 },
            },

            // Check and award achievements
            checkAchievements(studentData, sessionData) {
                const studentId = localStorage.getItem('studentId');
                let unlockedList = JSON.parse(localStorage.getItem(`achievements_${studentId}`) || '[]');
                let newAchievements = [];

                // Check first 50 XP
                if (studentData.totalXP >= 50 && !unlockedList.includes('first_50xp')) {
                    newAchievements.push('first_50xp');
                    unlockedList.push('first_50xp');
                }

                // Check first activity complete
                if (studentData.activitiesCompleted >= 1 && !unlockedList.includes('first_activity')) {
                    newAchievements.push('first_activity');
                    unlockedList.push('first_activity');
                }

                // Check perfect score
                if (sessionData && sessionData.accuracy === 1.0 && !unlockedList.includes('perfect_score')) {
                    newAchievements.push('perfect_score');
                    unlockedList.push('perfect_score');
                }

                // Check speed demon
                if (sessionData && sessionData.timeSpent < 120 && !unlockedList.includes('speed_demon')) {
                    newAchievements.push('speed_demon');
                    unlockedList.push('speed_demon');
                }

                // Check streaks
                if (studentData.maxStreak >= 3 && !unlockedList.includes('streak_3')) {
                    newAchievements.push('streak_3');
                    unlockedList.push('streak_3');
                }
                if (studentData.maxStreak >= 5 && !unlockedList.includes('streak_5')) {
                    newAchievements.push('streak_5');
                    unlockedList.push('streak_5');
                }
                if (studentData.maxStreak >= 10 && !unlockedList.includes('streak_10')) {
                    newAchievements.push('streak_10');
                    unlockedList.push('streak_10');
                }

                // Check daily challenge master
                if (studentData.dailyChallengesSolved >= 5 && !unlockedList.includes('daily_challenge_master')) {
                    newAchievements.push('daily_challenge_master');
                    unlockedList.push('daily_challenge_master');
                }

                // Check accuracy expert
                if (sessionData && sessionData.accuracy >= 0.9 && !unlockedList.includes('accuracy_expert')) {
                    newAchievements.push('accuracy_expert');
                    unlockedList.push('accuracy_expert');
                }

                // Check time-based achievements
                const hour = new Date().getHours();
                if (hour < 9 && !unlockedList.includes('early_bird')) {
                    newAchievements.push('early_bird');
                    unlockedList.push('early_bird');
                }
                if (hour >= 20 && !unlockedList.includes('night_owl')) {
                    newAchievements.push('night_owl');
                    unlockedList.push('night_owl');
                }

                // Save unlocked achievements
                localStorage.setItem(`achievements_${studentId}`, JSON.stringify(unlockedList));

                return newAchievements;
            },

            // Show achievement notification
            showAchievementNotification(achievementId) {
                const achievement = this.achievements[achievementId];
                if (!achievement) return;

                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 12px;
                    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    animation: slideIn 0.5s ease;
                    font-weight: bold;
                    text-align: center;
                    min-width: 300px;
                `;
                notification.innerHTML = `
                    <div style="font-size: 2em; margin-bottom: 10px;">${achievement.icon}</div>
                    <div style="font-size: 1.2em;">Achievement Unlocked!</div>
                    <div style="font-size: 1em; margin-top: 5px;">${achievement.name}</div>
                    <div style="font-size: 0.85em; margin-top: 5px; opacity: 0.9;">+${achievement.xp} Bonus XP</div>
                `;

                document.body.appendChild(notification);

                // Add animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);

                // Remove after 4 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }, 4000);
            }
        };

        // ============= DAILY LEADERBOARD =============
        
        const leaderboardSystem = {
            // Get today's date as key
            getTodayKey() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            },

            // Record session for leaderboard
            recordSession(studentId, studentName, xpEarned, accuracy, maxStreak, timeSpent) {
                const today = this.getTodayKey();
                const key = `leaderboard_${today}`;
                let leaderboard = JSON.parse(localStorage.getItem(key) || '{}');

                if (!leaderboard[studentId]) {
                    leaderboard[studentId] = {
                        name: studentName,
                        sessions: [],
                        totalXP: 0,
                        totalAccuracy: 0,
                        bestStreak: 0,
                        sessionCount: 0
                    };
                }

                leaderboard[studentId].sessions.push({
                    xp: xpEarned,
                    accuracy: accuracy,
                    streak: maxStreak,
                    time: timeSpent,
                    timestamp: new Date().toISOString()
                });

                leaderboard[studentId].totalXP += xpEarned;
                leaderboard[studentId].totalAccuracy = 
                    (leaderboard[studentId].totalAccuracy * leaderboard[studentId].sessionCount + accuracy) / 
                    (leaderboard[studentId].sessionCount + 1);
                leaderboard[studentId].bestStreak = Math.max(leaderboard[studentId].bestStreak, maxStreak);
                leaderboard[studentId].sessionCount++;

                localStorage.setItem(key, JSON.stringify(leaderboard));
            },

            // Get today's leaderboard
            getLeaderboard() {
                const today = this.getTodayKey();
                const key = `leaderboard_${today}`;
                const leaderboard = JSON.parse(localStorage.getItem(key) || '{}');

                const entries = Object.entries(leaderboard).map(([id, data]) => ({
                    studentId: id,
                    ...data
                }));

                return entries.sort((a, b) => b.totalXP - a.totalXP);
            },

            // Show leaderboard modal
            showLeaderboard() {
                const leaderboard = this.getLeaderboard();
                const modal = document.createElement('div');
                modal.id = 'leaderboardModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 30px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                `;

                let html = `
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">üìä Today's Leaderboard</h2>
                `;

                if (leaderboard.length === 0) {
                    html += '<p style="text-align: center; color: #999;">No sessions yet today</p>';
                } else {
                    html += '<table style="width: 100%; border-collapse: collapse;">';
                    leaderboard.forEach((entry, index) => {
                        const medals = ['ü•á', 'ü•à', 'ü•â'];
                        const medal = medals[index] || '4Ô∏è‚É£';
                        html += `
                            <tr style="border-bottom: 1px solid #eee; padding: 10px 0;">
                                <td style="padding: 10px; text-align: center;">${medal}</td>
                                <td style="padding: 10px;">${entry.name}</td>
                                <td style="padding: 10px; text-align: right;"><strong>${entry.totalXP} XP</strong></td>
                                <td style="padding: 10px; text-align: right;">${(entry.totalAccuracy * 100).toFixed(0)}%</td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                }

                html += `<button onclick="document.getElementById('leaderboardModal').remove()" style="width: 100%; margin-top: 20px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>`;

                content.innerHTML = html;
                modal.appendChild(content);
                document.body.appendChild(modal);
            }
        };

        // ============= CHALLENGE MODES =============
        
        const challengeSystem = {
            challenges: {
                'speed_challenge': {
                    name: '‚ö° Speed Challenge',
                    desc: 'Answer 5 questions in 30 seconds',
                    requirement: { questions: 5, timeLimit: 30 },
                    reward: 100,
                    icon: '‚ö°'
                },
                'accuracy_challenge': {
                    name: 'üéØ Accuracy Challenge',
                    desc: 'Get 5 correct in a row without mistakes',
                    requirement: { correctStreak: 5 },
                    reward: 75,
                    icon: 'üéØ'
                },
                'daily_grind': {
                    name: 'üî• Daily Grind',
                    desc: 'Earn 100+ XP today',
                    requirement: { dailyXP: 100 },
                    reward: 50,
                    icon: 'üî•'
                },
                'streak_master': {
                    name: 'üåü Streak Master',
                    desc: 'Maintain 7 correct answers in a row',
                    requirement: { correctStreak: 7 },
                    reward: 150,
                    icon: 'üåü'
                },
                'daily_challenge_blitz': {
                    name: 'üéÅ Challenge Blitz',
                    desc: 'Solve 3 daily challenges correctly',
                    requirement: { dailyChallengesCorrect: 3 },
                    reward: 80,
                    icon: 'üéÅ'
                }
            },

            // Show active challenges
            showChallenges() {
                const modal = document.createElement('div');
                modal.id = 'challengesModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 30px;
                    max-width: 700px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                `;

                let html = '<h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">üèÜ Active Challenges</h2>';

                Object.entries(this.challenges).forEach(([id, challenge]) => {
                    html += `
                        <div style="background: linear-gradient(135deg, ${['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'][Math.random() * 5 | 0]} 0%, ${['#FF8E72', '#44A08D', '#2E8B9E', '#FF7F50', '#7FDBCA'][Math.random() * 5 | 0]} 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">${challenge.icon}</div>
                            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">${challenge.name}</div>
                            <div style="font-size: 0.95em; margin-bottom: 8px;">${challenge.desc}</div>
                            <div style="font-size: 1em; font-weight: bold;">Reward: ${challenge.reward} XP</div>
                        </div>
                    `;
                });

                html += `<button onclick="document.getElementById('challengesModal').remove()" style="width: 100%; margin-top: 20px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>`;

                content.innerHTML = html;
                modal.appendChild(content);
                document.body.appendChild(modal);
            }
        };

        // ============= BADGE REWARD SYSTEM =============
        
        const badgeSystem = {
            badges: {
                'streak_3': { icon: 'üî•', name: '3x Hot', desc: '3 correct in a row', rarity: 'common' },
                'streak_5': { icon: 'üåü', name: '5x Star', desc: '5 correct in a row', rarity: 'uncommon' },
                'streak_10': { icon: 'üöÄ', name: '10x Rocket', desc: '10 correct in a row', rarity: 'rare' },
                'perfect_day': { icon: 'üíØ', name: 'Perfect Day', desc: '100% accuracy all day', rarity: 'epic' },
                'dedicated': { icon: 'üëë', name: 'Dedicated', desc: '7 day streak', rarity: 'legendary' },
                'daily_master': { icon: 'üéÅ', name: 'Daily Master', desc: 'Won 5 daily challenges', rarity: 'epic' }
            },

            // Award badge
            awardBadge(badgeId) {
                const studentId = localStorage.getItem('studentId');
                let badges = JSON.parse(localStorage.getItem(`badges_${studentId}`) || '[]');

                if (!badges.includes(badgeId)) {
                    badges.push(badgeId);
                    localStorage.setItem(`badges_${studentId}`, JSON.stringify(badges));
                    return true;
                }
                return false;
            },

            // Get badges
            getBadges() {
                const studentId = localStorage.getItem('studentId');
                const badgeIds = JSON.parse(localStorage.getItem(`badges_${studentId}`) || '[]');
                return badgeIds.map(id => ({ id, ...this.badges[id] }));
            },

            // Show badges with celebration
            showBadgeCelebration(badgeId) {
                const badge = this.badges[badgeId];
                if (!badge) return;

                const celebration = document.createElement('div');
                celebration.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    z-index: 10001;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
                    animation: popIn 0.5s ease;
                `;

                celebration.innerHTML = `
                    <div style="font-size: 4em; margin-bottom: 20px; animation: bounce 0.6s ease infinite;">${badge.icon}</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin-bottom: 10px;">Badge Unlocked!</div>
                    <div style="font-size: 1.3em; margin-bottom: 5px;">${badge.name}</div>
                    <div style="font-size: 0.95em; opacity: 0.9;">${badge.desc}</div>
                    <div style="font-size: 0.85em; margin-top: 10px; opacity: 0.8;">Rarity: ${badge.rarity}</div>
                `;

                const backdrop = document.createElement('div');
                backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes popIn {
                        0% { transform: translate(-50%, -50%) scale(0); }
                        50% { transform: translate(-50%, -50%) scale(1.1); }
                        100% { transform: translate(-50%, -50%) scale(1); }
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);

                document.body.appendChild(backdrop);
                document.body.appendChild(celebration);

                setTimeout(() => {
                    backdrop.remove();
                    celebration.remove();
                }, 4000);
            }
        };

        // Helper functions for gamification
        function showDailyLeaderboard() {
            leaderboardSystem.showLeaderboard();
        }

        function showActiveChallenges() {
            challengeSystem.showChallenges();
        }

        function checkAndAwardAchievements(studentData, sessionData) {
            const newAchievements = achievementSystem.checkAchievements(studentData, sessionData);
            newAchievements.forEach(achievementId => {
                achievementSystem.showAchievementNotification(achievementId);
            });
            return newAchievements;
        }

        function recordTodaysSession(studentId, studentName, xpEarned, accuracy, maxStreak, timeSpent) {
            leaderboardSystem.recordSession(studentId, studentName, xpEarned, accuracy, maxStreak, timeSpent);
        }
    </script>
</body>
</html>
